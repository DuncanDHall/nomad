# NOTE: keep in mind this file is _included_ by _other_ repos, and thus the env var names
# are not _always_ related to _this_ repo ;-)

# A GitLab group (ideally) or project will need to set [Settings] [CI/CD] [Variables]
#   NOMAD_ADDR
#   NOMAD_TOKEN
# to whatever your Nomad cluster was setup to.


# NOTE: very first pipeline, the [build] below will make sure this is created
image: registry.gitlab.com/internetarchive/nomad/master:latest


stages:
  - build
  - test
  - deploy
  - cleanup


include:
  # GitLab Auto DevOps' stock CI/CD [build] phase:
  - remote: 'https://gitlab.com/gitlab-org/gitlab-foss/-/raw/master/lib/gitlab/ci/templates/Jobs/Build.gitlab-ci.yml'
  # @see https://gitlab.com/gitlab-org/cluster-integration/auto-build-image/blob/master/src/build.sh


.nomad-vars:
  before_script:
    # make nice hostname, eg:
    #   services-timemachine.x.archive.org
    #   ia-petabox-webdev-3939-fix-things.x.archive.org
    # and a unique slug that factors in group, project, and branch (when not master)
    - |
      BRANCH_PART=""
      [ "$CI_COMMIT_REF_SLUG" != "master" ]  &&  BRANCH_PART="-${CI_COMMIT_REF_SLUG}"
      export NOMAD__SLUG=$(echo "${CI_PROJECT_PATH_SLUG}${BRANCH_PART}" |cut -b1-63)

      DOM=${KUBE_INGRESS_BASE_DOMAIN}
      [ "$NOMAD__HOSTNAME" = "" ]  &&  export NOMAD__HOSTNAME="${NOMAD__SLUG}.${DOM}"

      # For hcl2
      export NOMAD_VAR_SLUG=$NOMAD__SLUG
      export NOMAD_VAR_HOSTNAME=$NOMAD__HOSTNAME
      export NOMAD_VAR_HOSTNAMES='["'$NOMAD_VAR_HOSTNAME'"]'
      echo NOMAD_VAR_HOSTNAMES=$NOMAD_VAR_HOSTNAMES


deploy:
  extends: .nomad-vars
  stage: deploy
  script:
    # You can have your own/custom `project.nomad` in the top of your repo - or we'll just use
    # this fully parameterized nice generic 'house style' project
    - if [ ! -e project.nomad ];then wget -q https://gitlab.com/internetarchive/nomad/-/raw/master/project.nomad; fi

    - echo using nomad cluster $NOMAD_ADDR
    - echo deploying to https://$NOMAD_VAR_HOSTNAME

    # Swap out any env vars in `project.nomad` with environment values
    - node -e 'console.log(JSON.stringify(process.env))' >| /tmp/env.json
    - levant render -var-file=/tmp/env.json  project.nomad 2>/dev/null >| project.hcl

    # If we're using hcl2, ignore above levant
    - if [ $HCL2 ]; then rm -f project.hcl; fi
    - if [ $HCL2 ]; then wget -q https://gitlab.com/internetarchive/nomad/-/raw/master/project.hcl; fi
    - sed -i "s/NOMAD_VAR_SLUG/$NOMAD_VAR_SLUG/" project.hcl
    - node -e 'console.log(JSON.stringify(Object.fromEntries(Object.entries(process.env).filter(([k, v]) => k.startsWith("CI_")))))' >| /tmp/env.json
    - if [ $HCL2 ]; then nomad plan -var-file=/tmp/env.json project.hcl || echo; fi

    - rm /tmp/env.json

    - grep -vi password project.hcl | egrep -v '^\s*$'
    - nomad validate  -hcl1 project.hcl
    - nomad plan      -hcl1 project.hcl 2>&1 |sed 's/\(password[^ \t]*[ \t]*\).*/\1 ... /' || echo
    - if [ $HCL2 ]; then  nomad run project.hcl;  fi
    - if [ $HCL2 ]; then echo HCL1; else  nomad run -hcl1 project.hcl;  fi
    - echo deployed to https://$NOMAD_VAR_HOSTNAME

  environment:
    name: $CI_COMMIT_REF_SLUG
    url: https://$NOMAD_VAR_HOSTNAME
    on_stop: stop_review
  rules:
    - if: '$NOMAD__NO_DEPLOY'
      when: never
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: never
    - if: '$CI_COMMIT_TAG || $CI_COMMIT_BRANCH'


stop_review:
  # See:
  # https://gitlab.com/gitlab-org/gitlab-foss/blob/master/lib/gitlab/ci/templates/Jobs/Deploy.gitlab-ci.yml
  extends: .nomad-vars
  stage: cleanup
  variables:
    GIT_STRATEGY: none
  script:
    - nomad stop $NOMAD_VAR_SLUG
  environment:
    name: $CI_COMMIT_REF_SLUG
    action: stop
  dependencies: []
  allow_failure: true
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: never
    - if: '$NOMAD__NO_DEPLOY'
      when: never
    - if: '$CI_COMMIT_TAG || $CI_COMMIT_BRANCH'
      when: manual
